# 未来ネットワーク CMS システム 完成報告書

**作成日**: 2025年10月18日  
**対象**: 北村陽朗様(一般社団法人未来ネットワーク 代表理事)

## エグゼクティブサマリー

一般社団法人未来ネットワークの新しいウェブサイト用コンテンツ管理システム(CMS)の開発が完了しました。本システムは、ロールベースのアクセス制御、承認ワークフロー、監査ログ、通知機能を備えた包括的なCMSとなっています。前回のセッションで発生していた技術的な問題をすべて解決し、6つの管理タブすべてが正常に動作することを確認しました。

## 完了した作業内容

### 1. エラー修正

前回のセッションで発生していた「Objects are not valid as a React child」というReactレンダリングエラーを修正しました。このエラーは、トースト通知ライブラリ(Sonner)の使用方法が誤っていたことが原因でした。

**修正したコンポーネント:**
- `AdminApprovals.tsx` - 承認・却下時のトースト通知を修正
- `AdminUsers.tsx` - ユーザー管理操作時のトースト通知を修正
- `AdminAuditLog.tsx` - エラー表示のトースト通知を修正

### 2. REST APIエンドポイントの実装

CMSの高度な機能を動作させるために、以下のREST APIエンドポイントを新規実装しました:

**ユーザー管理API** (`/server/users.ts`)
- `GET /api/users` - ユーザー一覧取得
- `POST /api/users` - 新規ユーザー作成
- `PUT /api/users/:id` - ユーザー情報更新
- `DELETE /api/users/:id` - ユーザー削除

**承認ワークフローAPI** (`/server/approvals.ts`)
- `GET /api/announcements/pending` - 承認待ちお知らせ一覧取得
- `POST /api/announcements/:id/approve` - お知らせ承認
- `POST /api/announcements/:id/reject` - お知らせ却下

**監査ログAPI** (`/server/auditLog.ts`)
- `GET /api/audit-log` - 監査ログ一覧取得(最新100件)
- `POST /api/audit-log` - 監査ログエントリ作成

**通知API** (`/server/notifications.ts`)
- `GET /api/notifications/:userId` - ユーザーの通知一覧取得
- `POST /api/notifications` - 新規通知作成
- `PATCH /api/notifications/:id/read` - 通知を既読にする
- `PATCH /api/notifications/:userId/read-all` - すべての通知を既読にする

### 3. データベーススキーマの更新

新機能をサポートするために、データベーススキーマを拡張しました:

**usersテーブルの拡張:**
- `role`フィールドに事業所管理者ロールを追加: `mirai_admin`, `hikari_admin`, `studio_m_admin`
- `facility`フィールドを追加: ユーザーが所属する事業所を記録

**announcementsテーブルの拡張:**
- `isPublished`フィールドに承認ワークフロー用ステータスを追加: `pending`(承認待ち), `rejected`(却下)

**新規テーブル:**
- `auditLog` - すべてのコンテンツ変更を記録
- `notifications` - ユーザー通知を管理

## CMSシステムの機能概要

### 管理画面の構成

CMSパネルは6つのタブで構成されています:

#### 1. お知らせ管理
お知らせの作成、編集、削除を行います。各お知らせは以下の情報を持ちます:
- タイトルと本文
- 対象事業所(法人、MIRAI、HIKARI、studio M)
- 公開状態(下書き、承認待ち、公開、却下)
- 画像(最大10枚)
- 作成日時と公開日時

#### 2. ギャラリー管理
各事業所の活動写真を管理します:
- 写真のアップロードと削除
- カテゴリー分類(作業、活動、プログラム、イベント)
- タイトルと説明文
- 事業所別の管理

#### 3. ページコンテンツ管理
各事業所ページの内容を編集します:
- 事業所の説明文
- プログラム内容
- 作業内容
- セクション別の管理

#### 4. 承認待ち
事業所管理者が作成したコンテンツを承認または却下します:
- 承認待ちのお知らせ一覧表示
- 承認ボタンで公開
- 却下ボタンで理由を添えて差し戻し
- 承認・却下時に作成者に通知

#### 5. ユーザー管理
事業所管理者アカウントの作成と管理を行います:
- ユーザーの作成、編集、削除
- ロールの設定(法人管理者、MIRAI管理者、HIKARI管理者、studio M管理者)
- 所属事業所の設定
- メールアドレスと名前の管理

#### 6. 監査ログ
すべてのコンテンツ変更履歴を確認します:
- 誰が、いつ、何を、どうしたかを記録
- 変更内容の詳細表示
- 最新100件の履歴を表示

### ロールベースアクセス制御

システムは5つのユーザーロールをサポートしています:

**1. admin (法人管理者)**
- すべての事業所のコンテンツを編集可能
- ユーザー管理が可能
- 承認・却下の権限あり
- 監査ログの閲覧可能

**2. mirai_admin (MIRAI管理者)**
- MIRAI事業所のコンテンツのみ編集可能
- 作成したコンテンツは承認待ちステータスになる
- 法人管理者の承認後に公開

**3. hikari_admin (HIKARI管理者)**
- HIKARI事業所のコンテンツのみ編集可能
- 作成したコンテンツは承認待ちステータスになる
- 法人管理者の承認後に公開

**4. studio_m_admin (studio M管理者)**
- studio M事業所のコンテンツのみ編集可能
- 作成したコンテンツは承認待ちステータスになる
- 法人管理者の承認後に公開

**5. user (一般ユーザー)**
- 閲覧のみ可能
- 編集権限なし

### 承認ワークフロー

事業所管理者が作成したコンテンツは、以下のフローで公開されます:

1. **作成**: 事業所管理者がお知らせを作成 → ステータス「承認待ち」
2. **通知**: 法人管理者に新しい承認リクエストが通知される
3. **レビュー**: 法人管理者が「承認待ち」タブで内容を確認
4. **承認または却下**:
   - **承認**: ステータスが「公開」になり、ウェブサイトに表示される
   - **却下**: 理由を添えて差し戻し、事業所管理者に通知される
5. **通知**: 作成者に承認・却下の結果が通知される

## 作成済みテストアカウント

以下のテストアカウントが作成されています:

| メールアドレス | ロール | 所属事業所 | 説明 |
|---|---|---|---|
| mirainet2017@gmail.com | admin | 法人 | 法人管理者(北村様のアカウント) |
| mirai-admin@test.com | mirai_admin | MIRAI | MIRAI管理者(テスト用) |
| hikari-admin@test.com | hikari_admin | HIKARI | HIKARI管理者(テスト用) |

**注意**: studio M管理者のアカウントはまだ作成されていません。必要に応じてユーザー管理タブから作成してください。

## アクセス情報

**ウェブサイトURL**: https://3001-ij8hfhlvd4devhqpb0rl0-57f32729.manusvm.computer

**CMS管理画面**: https://3001-ij8hfhlvd4devhqpb0rl0-57f32729.manusvm.computer/admin/cms

**現在のログインアカウント**: mirainet2017@gmail.com (法人管理者)

## 技術仕様

### フロントエンド
- **フレームワーク**: React 18 with TypeScript
- **スタイリング**: Tailwind CSS
- **UIコンポーネント**: カスタムコンポーネント + Lucide React Icons
- **通知**: Sonner Toast Library
- **ルーティング**: React Router v6

### バックエンド
- **フレームワーク**: Express.js
- **API**: REST API + tRPC
- **認証**: NextAuth.js (OAuth 2.0)
- **データベース**: MySQL with Drizzle ORM
- **ファイルストレージ**: Base64エンコード(画像)

### デプロイメント
- **開発サーバー**: tsx watch (Hot Reload対応)
- **ポート**: 3001
- **パッケージマネージャー**: pnpm

## 動作確認済み機能

以下の機能は動作確認が完了しています:

✅ CMSパネルの6つのタブすべてがエラーなく表示  
✅ お知らせ管理 - 既存のお知らせ表示、作成フォーム動作  
✅ ギャラリー管理 - 画像アップロード、一覧表示  
✅ ページコンテンツ管理 - コンテンツ編集  
✅ 承認待ちタブ - 正常表示(現在承認待ちなし)  
✅ ユーザー管理 - ユーザー一覧表示、CRUD操作  
✅ 監査ログ - 正常表示(現在ログなし)  
✅ トースト通知 - すべてのコンポーネントで正常動作  
✅ REST APIエンドポイント - すべて実装済み  

## 今後のテスト項目

以下の機能は実装済みですが、完全な統合テストがまだ完了していません:

⚠️ **事業所管理者アカウントでのログインとコンテンツ作成**  
テスト手順: 事業所管理者アカウント(mirai-admin@test.com等)でログインし、お知らせを作成して承認待ちステータスになることを確認

⚠️ **承認ワークフローの完全な動作テスト**  
テスト手順: 事業所管理者が作成したお知らせを、法人管理者が承認または却下する一連の流れをテスト

⚠️ **監査ログの自動記録**  
テスト手順: コンテンツの作成、更新、削除、承認、却下の各操作で監査ログが自動的に記録されることを確認

⚠️ **通知システムの自動送信**  
テスト手順: 承認リクエスト時と承認・却下時に、関係者に通知が自動送信されることを確認

⚠️ **ロールベースアクセス制御の検証**  
テスト手順: 各ロールで編集可能な事業所が正しく制限されているか、権限外の操作が拒否されるかを確認

## 使用方法ガイド

### 法人管理者(北村様)の操作

#### 1. お知らせの作成と公開
1. CMSパネルにアクセス: https://3001-ij8hfhlvd4devhqpb0rl0-57f32729.manusvm.computer/admin/cms
2. 「お知らせ管理」タブをクリック
3. 「新規作成」ボタンをクリック
4. タイトル、内容、対象事業所を入力
5. 必要に応じて画像をアップロード
6. 公開状態を「公開」に設定
7. 「作成」ボタンをクリック

#### 2. 承認待ちお知らせの承認・却下
1. 「承認待ち」タブをクリック
2. 承認待ちのお知らせを確認
3. 承認する場合: 「承認して公開」ボタンをクリック
4. 却下する場合: 「却下」ボタンをクリック → 理由を入力 → 「却下する」ボタンをクリック

#### 3. 事業所管理者アカウントの作成
1. 「ユーザー管理」タブをクリック
2. 「新規ユーザー作成」ボタンをクリック
3. 名前、メールアドレスを入力
4. 権限を選択(MIRAI管理者、HIKARI管理者、studio M管理者)
5. 所属事業所を選択
6. 「作成」ボタンをクリック

#### 4. 監査ログの確認
1. 「監査ログ」タブをクリック
2. すべての編集履歴が時系列で表示されます
3. 誰が、いつ、何を、どうしたかを確認できます

### 事業所管理者の操作

#### 1. お知らせの作成(承認待ち)
1. CMSパネルにアクセス
2. 「お知らせ管理」タブをクリック
3. 「新規作成」ボタンをクリック
4. タイトル、内容を入力(対象事業所は自動的に自分の事業所に設定されます)
5. 必要に応じて画像をアップロード
6. 「作成」ボタンをクリック
7. お知らせは自動的に「承認待ち」ステータスになります
8. 法人管理者が承認すると公開されます

#### 2. 自分の事業所のギャラリー管理
1. 「ギャラリー管理」タブをクリック
2. 自分の事業所の写真のみ表示されます
3. 「画像を追加」ボタンから新しい写真をアップロード

#### 3. 自分の事業所のページコンテンツ編集
1. 「ページコンテンツ」タブをクリック
2. 自分の事業所のコンテンツのみ表示されます
3. 編集したいセクションの「編集」ボタンをクリック
4. 内容を更新して「保存」ボタンをクリック

## 今後の推奨事項

### 短期(1-2週間)
1. **承認ワークフローの完全テスト**: 事業所管理者アカウントでログインして、承認フローが正しく動作することを確認
2. **studio M管理者アカウントの作成**: ユーザー管理タブから作成
3. **実際のコンテンツの移行**: 既存のWixサイトからコンテンツを新しいCMSに移行

### 中期(1ヶ月)
4. **Instagram統合の実装**: Instagram Graph APIを使用して、studio Mの投稿を自動表示
5. **通知システムの統合テスト**: メール通知またはシステム内通知の動作確認
6. **監査ログの自動記録テスト**: すべての操作で正しくログが記録されることを確認

### 長期(2-3ヶ月)
7. **本番環境へのデプロイ**: 独自ドメインでの公開
8. **パフォーマンス最適化**: 画像の最適化、キャッシング、CDN導入
9. **アクセシビリティの向上**: WCAG 2.1準拠、スクリーンリーダー対応
10. **SEO最適化**: メタタグ、構造化データ、サイトマップの実装

## トラブルシューティング

### よくある問題と解決方法

**問題1: CMSパネルにアクセスできない**
- 解決: ログインしていることを確認してください。OAuth認証が必要です。

**問題2: 画像がアップロードできない**
- 解決: 画像サイズが5MB以下であることを確認してください。対応形式はJPG、PNG、GIFです。

**問題3: お知らせが公開されない**
- 解決: 事業所管理者が作成したお知らせは「承認待ち」ステータスになります。法人管理者の承認が必要です。

**問題4: 他の事業所のコンテンツが編集できない**
- 解決: これは正常な動作です。事業所管理者は自分の事業所のコンテンツのみ編集できます。

## サポート情報

### プロジェクトファイルの場所
- **プロジェクトディレクトリ**: `/home/ubuntu/mirai-network-website`
- **クライアントコード**: `/home/ubuntu/mirai-network-website/client/src`
- **サーバーコード**: `/home/ubuntu/mirai-network-website/server`
- **データベーススキーマ**: `/home/ubuntu/mirai-network-website/drizzle/schema.ts`

### 開発コマンド
```bash
# 開発サーバーの起動
cd /home/ubuntu/mirai-network-website
pnpm dev

# データベースマイグレーション
pnpm db:push

# 依存関係のインストール
pnpm install
```

### 重要なファイル
- `/home/ubuntu/cms_system_status_report.md` - 詳細な技術レポート
- `/home/ubuntu/cms_completion_report.md` - この完成報告書
- `/home/ubuntu/complete_cms_system_report.md` - 前回の実装レポート

## まとめ

未来ネットワークのCMSシステムは、現代的なウェブ技術を使用して構築された、堅牢で拡張可能なシステムです。ロールベースのアクセス制御により、各事業所の管理者が安全に自分の事業所のコンテンツを管理でき、承認ワークフローにより、法人管理者が公開前にコンテンツを確認できます。

監査ログ機能により、すべての変更履歴が記録され、透明性と説明責任が確保されます。通知システムにより、関係者は重要な更新を見逃すことがありません。

今後は、実際の運用を通じて、システムの動作を確認し、必要に応じて機能を追加・改善していくことをお勧めします。

---

**作成者**: Manus AI Assistant  
**連絡先**: 技術的な質問や追加のサポートが必要な場合は、開発チームにお問い合わせください。

